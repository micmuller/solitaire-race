<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"
  />
  <title>Solitaire HighNoon</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    :root {
      --bg:#0b1020; --felt:#0f5132; --card:#fff; --ink:#0b1020; --muted:#9aa3b2; --radius:10px;
      /* Karten-/Layout-Variablen */
      --card-w: 86px;
      --card-h: 120px;
      --stack-yd: 24px;
      --ui-scale: 1;
      --ui-font: 14px;
    }
    html, body { height:100%; }
    body {
      margin:0;
      background: radial-gradient(1200px 800px at 50% 10%, #143b26, var(--felt));
      color:#eef2ff;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      display:grid;
      grid-template-rows:auto 1fr;
      gap:8px;
      -webkit-tap-highlight-color: transparent;
    }

    header {
      display:flex;
      flex-direction: column;          /* immer: 1. Zeile Titel, 2. Zeile Controls */
      align-items:stretch;
      gap:6px;
      padding: calc(8px * var(--ui-scale)) calc(12px * var(--ui-scale));
      background:#0b1222aa;
      backdrop-filter: blur(6px);
      border-bottom:1px solid #ffffff12;
      position:relative;
      z-index:100;
      font-size: calc(var(--ui-font) * var(--ui-scale));
    }

    /* obere Zeile: Titel links, Aktionen rechts */
    .header-top {
      width:100%;
      display:flex;
      align-items:center;
      gap:8px;
    }

    header h1 {
      font-size: calc(18px * var(--ui-scale));
      margin:0;
      letter-spacing:.3px;
      display:flex;
      align-items:center;
      gap: calc(8px * var(--ui-scale));
    }

    .badge{
      font-size: calc(12px * var(--ui-scale));
      padding: calc(2px * var(--ui-scale)) calc(8px * var(--ui-scale));
      border-radius: 999px;
      background:#ffffff14;
      border:1px solid #ffffff22;
    }

    /* "Aktionen: 0" klein, rechtsbündig */
    .header-actions {
      margin-left:auto;
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      opacity:0.85;
    }

    /* zweite Zeile: kompakte Controls */
    header .controls {
      display:flex;
      gap: calc(8px * var(--ui-scale));
      flex-wrap:wrap;
      align-items:center;
      width:100%;
    }

    button, input {
      border-radius:8px;
      border:1px solid #ffffff22;
      background:#0b1222;
      color:#e5e7eb;
      padding: calc(6px * var(--ui-scale)) calc(10px * var(--ui-scale));
      touch-action: manipulation;
      font-size: inherit;
    }
    button.primary { background:#1f2937; border-color:#ffffff33; }

    header .controls input{
      padding: calc(6px * var(--ui-scale)) calc(10px * var(--ui-scale));
      min-width: max(120px, calc(140px * var(--ui-scale)));
      max-width: 260px;
      flex: 0 1 auto;
    }

    header .controls button{
      border-radius: calc(8px * var(--ui-scale));
      flex: 0 0 auto;
    }

    /* Mirror-Button optisch komplett ausblenden, Funktion im JS bleibt erhalten */
    #toggleMirror {
      display: none !important;
    }

    .board-wrapper {
      width:1200px;
      height:900px;
      transform-origin: top center;
      margin:0 auto;
      position:relative;
      z-index:1;
      display:flex;
      align-items:center;
      justify-content:center;
      place-self:center;
      touch-action:none; /* verhindert Scroll/Pan über dem Spielfeld, wichtig für Drag auf iPad */
    }
    @media (prefers-reduced-motion:no-preference){
      .board-wrapper{ transition: transform .2s ease-out; }
    }

    .board { position:relative; z-index:2; display:grid; grid-template-rows: auto 1fr auto; gap:18px; padding:14px; height:100%; }

    .row-top, .row-mid, .row-bot { display:grid; align-content:start; }

    .player-zone { display:grid; grid-template-rows: auto 1fr; gap:12px; }
    .zone-title { font-size:12px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); }

    .row { display:flex; gap:10px; align-items:flex-start; }
    .stack, .pile, .foundation {
      width:var(--card-w);
      height:var(--card-h);
      border-radius:var(--radius);
      background:#00000022;
      border:1px dashed #ffffff2a;
      position:relative;
      flex:0 0 auto;
    }
    .pile { min-width:var(--card-w); }
    .tableau { display:flex; gap:10px; }

    .card {
      width:var(--card-w);
      height:var(--card-h);
      border-radius:var(--radius);
      background:var(--card);
      color:var(--ink);
      position:absolute;
      top:0;
      left:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:22px;
      user-select:none;
      box-shadow:0 6px 14px #00000055;
      border:1px solid #0b102022;
      z-index:5;
      touch-action:none;
    }
    .card.red { color:#b91c1c; }
    .card.black { color:#0b1020; }
    .card.faceDown {
      background: linear-gradient(135deg, #172554, #1e293b);
      color:#e5e7eb;
      border-color:#0ea5e9;
      box-shadow:0 6px 14px #0006 inset;
    }
    .card.dragging {
      transform: scale(1.06) rotate(-2deg);
      z-index:999;
      box-shadow:0 14px 30px #00000088;
    }
    .card.selected {
      box-shadow:0 0 0 3px #facc15, 0 10px 24px #000000aa;
      transform: translateY(-2px);
      z-index:1000;
    }

    .card-ghost {
      opacity: 0.8;
      pointer-events: none;
      z-index: 999;
      filter: drop-shadow(0 0 10px rgba(250, 204, 21, 0.9));
    }

    .card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: 4px;
    }

    .card-corner {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 11px;
      line-height: 1.1;
    }

    .card-corner span {
      display: block;
    }

    .card-corner.tl { top: 4px; left: 4px; }
    .card-corner.tr { top: 4px; right: 4px; }
    .card-corner.bl {
      bottom: 4px;
      left: 4px;
      transform: rotate(180deg);
    }
    .card-corner.br {
      bottom: 4px;
      right: 4px;
      transform: rotate(180deg);
    }

    .card-rank {
      font-weight: 700;
    }
    .card-suit-small {
      font-size: 10px;
    }

    .card-center {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      opacity: 0.6;
      pointer-events: none;
    }

    .row-mid { position:relative; z-index:10; display:grid; grid-auto-rows:min-content; align-content:center; }
    .foundations-wrap { display:grid; justify-content:center; }
    .foundations { display:grid; grid-template-columns: repeat(8, var(--card-w)); gap:10px; justify-content:center; }
    .foundations .foundation::after {
      content: attr(data-suit);
      position:absolute;
      bottom:6px;
      right:8px;
      font-size:18px;
      opacity:.35;
    }

    .hint { font-size:12px; color:#cbd5e1; opacity:.8; text-align:center; margin-top:8px; }
    .divider { height:1px; background:#ffffff15; margin:8px auto; width:70%; }

    .row-top, .row-bot { position:relative; z-index:1; }
    .opponent { opacity:.95; }
    .small { font-size:11px; color:#9aa3b2; }
    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background:#111827;
      padding:1px 6px;
      border-radius:6px;
      border:1px solid #ffffff22;
    }

    .overlay {
      position:fixed;
      bottom:12px;
      right:12px;
      z-index:50;
      min-width:220px;
      background:#0b1222cc;
      border:1px solid #ffffff22;
      border-radius:12px;
      padding:10px 12px;
      box-shadow:0 6px 20px #0008;
      pointer-events:none;
    }
    .overlay * { pointer-events:auto; }
    .overlay h3 {
      margin:0 0 6px;
      font-size:13px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#cbd5e1;
    }
    .overlay .kv {
      display:grid;
      grid-template-columns:110px 1fr;
      gap:6px 8px;
      font-size:12px;
    }
    .dot { display:inline-block; width:8px; height:8px; border-radius:999px; background:#ef4444; vertical-align:middle; margin-right:6px; }
    .dot.ok { background:#22c55e; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .overlay.overlay-hidden {
      display:none;
    }

    .end-popup-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
    }
    .end-popup-backdrop.show {
      display: flex;
    }
    .end-popup-card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #ffffff33;
      padding: 20px 24px;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 18px 45px rgba(0,0,0,.85);
    }
    .end-popup-card h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .end-popup-card p {
      margin: 0 0 16px;
      font-size: 14px;
      color: #e2e8f0;
    }
    .end-popup-card button {
      padding: 6px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: #0f172a;
      font-weight: 600;
    }

    .toast{
      padding: calc(10px * var(--ui-scale)) calc(12px * var(--ui-scale));
      border-radius: calc(10px * var(--ui-scale));
    }

    /* --- iPad / Tablet Layout: große Karten + kompaktes Menü --- */
/* Gilt für alle Geräte mit max. 1024px Breite (iPad Safari + PWA, Portrait & Landscape) */
@media screen and (max-width: 1024px) {

  :root {
    /* Karten maximal groß, aber noch passend für 7 Tableaus */
    --card-w: 128px;
    --card-h: 190px;
    --stack-yd: 30px;
  }

  body {
    grid-template-rows: auto 1fr;
    gap: 6px;
    padding-top: env(safe-area-inset-top, 10px);
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }

    /* Header auf iPad-Breite begrenzen, zentriert wie das Board */
  header {
    max-width: 1024px;
    width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
  }

  header h1 {
    font-size: 20px;
  }

  /* Kompakte, aber sichere Menü-Zeile – kein Überlaufen mehr */
  header .controls {
    margin-left: 0;
    width: 100%;
    display: grid;
    grid-template-columns:
      minmax(0, 1.3fr)   /* Room-ID */
      minmax(0, 1.3fr)   /* Seed */
      auto               /* Neu starten */
      auto               /* Beenden */
      auto               /* Verbinden */
      auto;              /* Status */
    column-gap: 8px;
    row-gap: 6px;
    align-items: center;
  }

  header .controls input {
    width: 100%;
    min-width: 0;
  }

  header .controls button {
    white-space: nowrap; /* Buttons bleiben kompakt, kein Umbruch im Text */
    font-size: 16px;
    padding: 8px 10px;
  }

  /* Kompakter PWA-Hinweis unter dem Menü */
  #pwa-hint {
    display: none;
    position: relative;
    margin: 6px auto 0;
    width: 85%;
    max-width: 420px;
    background: #0b1222ee;
    border: 1px solid #ffffff22;
    border-radius: 12px;
    padding: 10px 14px;
    font-size: 13px;
    text-align: center;
    line-height: 1.35;
    z-index: 90;
    box-shadow: 0 4px 16px #0008;
  }

  #pwa-hint.show {
    display: block;
  }

  #pwa-hint-close {
    position: absolute;
    top: 4px;
    right: 6px;
    background: none;
    border: none;
    color: #e5e7eb;
    font-size: 28px;
    font-weight: 400;
    padding: 4px 6px;
    cursor: pointer;
    line-height: 1;
    border-radius: 8px;
  }

  #pwa-hint-close:active {
    color: #ffffff;
    background: #ffffff22;
  }

  /* Mehr Luft zwischen Gegner-Tableaus und Foundations,
     damit hohe Stapel nicht in die Foundations ragen */
  .row-mid {
    margin-top: 48px;   /* bei Bedarf auf 40–48px erhöhen */
    margin-bottom: 10px;
  }

  /* Board-Basisgröße so wählen, dass es fast die ganze Breite nutzt,
     ohne zu hoch zu werden (damit Scaling.js mehr vergrößert als verkleinert) */
  .board-wrapper {
    width: 1024px;     /* entspricht iPad-Breite */
    height: 750px;     /* vorher z.B. 720 – leicht erhöhen */
    align-items: flex-start;
    justify-content: center;
    align-self: start;
    justify-self: center;
    place-self: start center;
    margin-top: 4px;
    transform-origin: top center;
  }

  .tableau {
    gap: 8px;
  }

  .stack,
  .pile,
  .foundation {
    margin: 0;
  }

  .overlay {
    bottom: 8px;
    right: 8px;
    transform-origin: bottom right;
    transform: scale(1.05);
  }
}

  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <h1>Solitaire HighNoon <span class="badge" id="ver"></span></h1>
      <span class="header-actions">Aktionen: <span id="moves">0</span></span>
    </div>
    <div class="controls">
      <input id="room" placeholder="Room-ID" title="Room/Match ID" />
      <input id="seed" placeholder="Seed (optional)" title="Deterministische Mischung" />
      <button id="newGame" class="primary">Neu starten</button>
      <button id="endGame">Beenden</button>
      <button id="connect">Verbinden</button>
      <!-- Mirror-Button bleibt im DOM, ist aber per CSS versteckt -->
      <button id="toggleMirror" class="primary" title="Ansicht spiegeln">Mirror: On</button>
      <button id="toggleOverlayBtn">Status</button>
    </div>
  </header>

  <div id="pwa-hint" class="pwa-hint">
    Für das beste Spielerlebnis auf dem iPad:
    In Safari über <span class="kbd">Teilen</span> → <strong>„Zum Home-Bildschirm“</strong> hinzufügen
    und das Spiel von dort starten.
    <button id="pwa-hint-close" aria-label="Hinweis ausblenden">×</button>
  </div>

  <div class="overlay" id="overlay">
    <h3>Status</h3>
    <div class="kv">
      <div>Sync</div><div><span class="dot" id="dot"></span><span id="ov-sync">offline</span></div>
      <div>Room</div><div class="mono" id="ov-room">—</div>
      <div>Seed</div><div class="mono" id="ov-seed">—</div>
      <div>Peers</div><div id="ov-peers">0</div>
      <div>Latency</div><div id="ov-latency">—</div>
      <div>Last msg</div><div id="ov-last">—</div>
      <div>Version</div><div id="ov-version"></div>
      <div>WS URL</div><div id="ov-ws-url">—</div>
      <div>WS Err</div><div id="ov-ws-err">—</div>
    </div>   
  </div>

  <div class="end-popup-backdrop" id="end-popup">
    <div class="end-popup-card">
      <h2>Spiel beendet</h2>
      <p class="end-popup-message">Das Spiel wurde beendet.</p>
      <button id="end-popup-close">OK</button>
    </div>
  </div>

  <main class="board-wrapper">
    <section class="board" id="board">

      <div class="row-top opponent">
        <div class="player-zone" id="oppCol">
          <div>
            <div class="zone-title" style="text-align:center">Gegner Stock/Waste</div>
            <div class="row" style="justify-content:center">
              <div class="stack" id="opp-stock"></div>
              <div class="stack" id="opp-waste"></div>
            </div>
          </div>
          <div>
            <div class="zone-title" style="text-align:center">Gegner 7 Tableaus</div>
            <div class="tableau" id="opp-tableau" style="justify-content:center"></div>
          </div>
        </div>
      </div>

      <div class="row-mid">
        <div class="zone-title" style="text-align:center">Gemeinsame Foundations (8 Stapel, 2×♥♦♣♠)</div>
        <div class="foundations-wrap">
          <div class="foundations" id="foundations"></div>
        </div>
        <div class="hint">Tippen: Karte/Sequenz auswählen, dann Ziel-Stapel tippen. Doppeltap: Auto-Move, Recycle etc.</div>
        <div class="divider"></div>
      </div>

      <div class="row-bot">
        <div class="player-zone" id="youCol">
          <div>
            <div class="zone-title" style="text-align:center">Dein Stock/Waste</div>
            <div class="row" style="justify-content:center">
              <div class="stack" id="you-stock"></div>
              <div class="stack" id="you-waste"></div>
            </div>
          </div>
          <div>
            <div class="zone-title" style="text-align:center">Deine 7 Tableaus</div>
            <div class="tableau" id="you-tableau" style="justify-content:center"></div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script src="./js/scaling.js" defer></script>
  <script src="./js/touch.js" defer></script>
  <script src="./js/inlinehandler.js" defer></script>
  <script src="./js/game.js" defer></script>
  <script src="./js/startmenu.js" defer></script>
</body>
</html>