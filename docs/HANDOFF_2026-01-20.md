# ğŸ§  Handoff â€“ Solitaire HighNoon
**Datum:** 2026-01-20  
**Session-Fokus:** P1 â†’ Ãœbergang zu server-authoritativem State (Teilweise), Stabilisierung  
**Status:** Session bewusst beendet, stabiler RÃ¼cksprung erreicht

---

## ğŸ” Aktueller Stand (Ende Session)

### âœ… Was funktioniert
- **iOS â†” iOS**
  - Spielstart funktioniert wieder
  - Matches kÃ¶nnen erstellt & beigetreten werden
  - Gameplay grundsÃ¤tzlich mÃ¶glich

### âš ï¸ Bekannte Probleme
- **Server-Log**
  - Viele `[CORRUPTION] duplicate_card_ids`
  - Ursache: Legacy client-supplied Snapshots (208 Karten = 4Ã—52)
  - AIRBAG verteilt weiterhin gecachte Legacy-Snapshots

- **iOS â†” BOT**
  - Spiel startet technisch
  - Board bleibt **leer**
  - Server-Log:
    - `state_request served-from-cache`
    - anschlieÃŸend AIRBAG wegen `duplicate_card_ids`
    - Bot wartet auf gÃ¼ltigen Snapshot (`noch kein Snapshot vom Client`)

---

## ğŸ§  Root-Cause-Zusammenfassung

### Architektur-Zustand
- **Client**
  - iOS sendet wieder Moves korrekt
  - iOS ist *nicht* mehr zuverlÃ¤ssig Snapshot-Autor
- **Server**
  - Match-Lifecycle wieder stabil (nach Rollback)
  - **Aber:**
    - Legacy-Client-State wird weiterhin
      - validiert
      - gecached
      - per AIRBAG ausgeliefert
- **Bot**
  - AbhÃ¤ngig von Snapshot
  - Kein serverseitiger Initial-State â†’ Bot ohne Spielbasis

### Zentrale Ursache
> **Es existiert kein serverseitiger Initial Game State.**  
> Stattdessen werden weiterhin alte, korruptionsanfÃ¤llige Client-Snapshots recycelt.

---

## ğŸ›‘ Bewusste Entscheidungen dieser Session

- âŒ Kein weiterer Umbau am Client (WebSocketManager nach Rollback stabil)
- âŒ Kein weiterer Versuch, Legacy-Snapshots â€halb zu verbietenâ€œ
- âŒ Kein Bot-Fix ohne serverseitigen State
- âœ… Stabiler RÃ¼cksprung auf funktionierenden iOSâ†”iOS-Stand
- âœ… Session beendet, bevor Match-/Invite-Lifecycle erneut destabilisiert wird

---

## ğŸ¯ Kurzfristige Ziele (nÃ¤chste Session)

### **P1.3 â€“ Server Initial Snapshot (oberste PrioritÃ¤t)**
**Ziel:** Server wird *Single Source of Truth*

1. **Server erzeugt Initial Game State**
   - Deck-Erzeugung
   - Shuffle (shared / split korrekt)
   - Klondike-Deal
2. **Einmaliges `STATE_SNAPSHOT` beim Match-Start**
   - vor Bot-Start
   - vor Client-Interaktion
3. **AIRBAG nur noch Server-Snapshots ausliefern**
4. **Client `state_request` wird immer serverseitig beantwortet**

ğŸ‘‰ Ergebnis:
- iOS â†” BOT funktioniert
- iOS â†” iOS ohne Corruption
- Keine 208-Karten-ZustÃ¤nde mehr

---

## ğŸ§© Mittelfristige Ziele

### **P2 â€“ Server-Authoritative Moves**
- Clients senden nur noch `intent`
- Server:
  - validiert
  - applied
  - broadcastet
- EinfÃ¼hrung:
  - `matchRev`
  - `MOVE_ACK / MOVE_REJECT`

### **Bot-Integration**
- Bot agiert wie normaler Server-Client
- Kein eigener State
- Kein Client-Snapshot-AbhÃ¤ngigkeit

### **AIRBAG / Drift**
- AIRBAG nur noch fÃ¼r:
  - Out-of-order
  - reconnect
- Kein Replay von Legacy-ZustÃ¤nden

---

## ğŸ§­ Langfristige Leitlinien (bestÃ¤tigt)

- **Server Authority > Client Convenience**
- **Determinism > Optimistic UI**
- **Protocol Stability > schnelle Fixes**
- **Match-Lifecycle-StabilitÃ¤t vor Spiellogik**

---

## ğŸ“Œ Empfohlener Einstiegspunkt nÃ¤chste Session

1. `matches.js`
2. Implementiere **Server Initial Deal + Snapshot**
3. Danach:
   - iOSâ†”BOT testen
   - Corruption-Logs Ã¼berprÃ¼fen
4. Erst danach weitere Architektur-Schritte

---

## âœï¸ Notizen
- Rollback war korrekt und notwendig
- Eskalation war strukturell, nicht logisch
- Aktueller Zustand ist **stabil genug**, um sauber weiterzuarbeiten

**Session-Ende bewusst gewÃ¤hlt.**