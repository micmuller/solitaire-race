# ğŸ§  Handoff â€“ Solitaire HighNoon
**Datum:** 2026-01-23  
**Session-Fokus:** P1.3 Stabilisierung + Bot-Integration + Guardrails (M7)  
**Status:** iOS/BOT spielbar, Corruption weg, Bot-Duplicate-Suppression aktiv

---

## âœ… Was heute erreicht wurde

### 1) Corruption / Legacy-Snapshot Problem gelÃ¶st
- `[CORRUPTION] duplicate_card_ids expected=52 found=208` ist **weg** (server-seitige Authoritative Snapshot Pipeline greift).
- iOS/BOT startet nun mit **sichtbarem Board** (Karten werden korrekt initialisiert und gesnapshottet).

### 2) ServerBot Move-Pipeline gehÃ¤rtet (M7 + Guardrails)
- Bot-Moves laufen nun Ã¼ber eine serverseitige Ingestion, inkl.
  - `meta.moveId` (De-Dup kompatibel)
  - `meta.matchRev` (Sequencing)
  - **Echo an alle** (deterministisch)
- ZusÃ¤tzlich: **Server-level Duplicate Suppression** via `sig` + Zeitfenster.
  - Nachweis im Log:  
    `duplicate move suppressed matchId="J46GG" sig="toFound:..."`

### 3) Versionierung / Patch-Log gepflegt
- `server.js` auf **v2.4.10** (Guardrails/ServerBot-Ingestion + Duplicate Suppression)

---

## ğŸ§© Aktueller Stand

### âœ… Funktioniert
- iOS â†” BOT: Match startet, Board initial korrekt, Bot sendet Moves.
- Duplicate-Spam (derselbe Move mehrfach) wird serverseitig unterdrÃ¼ckt.

### âš ï¸ Noch offen / bekannte Probleme
1) **â€œIllegal movesâ€ des Bots**
   - Bot kann weiterhin Moves generieren, die aus Rules-Sicht ungÃ¼ltig sind.
   - Aktuell werden diese Moves zwar teilweise durch Snapshots â€œeingefangenâ€, aber nicht sauber server-authoritativ abgelehnt.

2) **Bot-State/Telemetry wirkt inkonsistent**
   - Beispiel: Bot legt Ass auf Foundation, aber `state update f=0` im Bot-State-Log.
   - Vermutung: Bot-State basiert auf Client-Bot-State-Snapshot und/oder dessen Aggregation/Mapping stimmt noch nicht vollstÃ¤ndig.

---

## ğŸ¯ Ziele fÃ¼r morgen (PrioritÃ¤t)

### P1 â€“ Server-authoritative Move Validation (minimal, ohne Protokollbruch)
**Ziel:** Kein Bot/Client darf serverseitig einen ungÃ¼ltigen Move broadcasten/applien.

- Serverseitig einen Validate/Apply Pfad fÃ¼r Moves etablieren (mindestens fÃ¼r Bot-Moves):
  - `validateMove(state, move, actor)` â†’ ok/err
  - nur bei ok: broadcast + state update
  - bei err: drop + log `[MOVE_REJECT] ...`
- Wichtig: **kein Breaking Change** am Protokoll (MOVE_REJECT kann intern bleiben oder als sys optional spÃ¤ter).

**Erwartetes Ergebnis:** â€œIllegal movesâ€ verschwinden vollstÃ¤ndig (Bot kann Mist vorschlagen, aber Server blockt).

### P2 â€“ Bot-State Konsistenz
**Ziel:** Bot trifft Entscheidungen auf korrekter Datengrundlage.
- PrÃ¼fen, ob `bot_state` Snapshot-Felder (foundationsTotal etc.) korrekt aus iOS kommen
- Mapping/Interpretation in `serverbot.js` prÃ¼fen (z.B. owner/side, tableau/waste/stock)
- Optional: Bot-State Snapshot vom Server liefern (spÃ¤ter), aber morgen zuerst nur Debug/Mapping.

### P3 â€“ Regression-Tests Protokoll / Drift
**Ziel:** Sicherstellen, dass P1.3 + Guardrails keine Nebenwirkungen verursachen.
- iOS â†” iOS: 10â€“20 Moves, reconnect, state_request spamtest
- iOS â†” BOT: 20+ Ticks, keine Duplicate Broadcasts, keine Corruption
- Optional: Web â†” iOS Basic Join/Start/Snapshot

---

## ğŸ§ª Test-Checkliste (konkret)

### Test A: iOS/BOT Duplicate-Suppression
1. iOS: BOT match starten
2. Log beobachten:
   - Erwartung: bei Wiederholung identischer Move-Signatur erscheint  
     `duplicate move suppressed ...`
   - Erwartung: kein zweiter `[BROADCAST] kind=move` fÃ¼r exakt denselben `sig` innerhalb des Fensters

### Test B: â€œIllegal moveâ€ Guard (nach morgigem Patch)
1. iOS: BOT match starten
2. Bot soll irgendwann einen invalid Move versuchen
3. Erwartung:
   - Server loggt `[MOVE_REJECT] ...`
   - Move wird **nicht** gebroadcastet
   - Board bleibt konsistent, Snapshots bleiben stabil

### Test C: Snapshot / state_request
1. iOS im Match: mehrfach `state_request` triggern (z.B. reconnect / UI action)
2. Erwartung:
   - `served-from-cache` ok
   - keine AIRBAG/Corruption
   - `matchRev` monotonic, `snapshotHash` plausibel

---

## ğŸ—‚ï¸ Betroffene Files (heute)
- `server.js` (v2.4.10): ServerBot-Ingestion + Duplicate Suppression + M7 Pipeline wiring
- `matches.js` (aus P1.3 zuvor): server-authoritative initial deal + snapshot + legacy snapshot recycling gestoppt
- `WebSocketManager.swift` (aus P1.x zuvor): snapshot handling / fromCid/selfCid wiring (iOS swap issue)

---

## ğŸ“Œ Empfehlung Einstieg morgen
1) `matches.js` oder ein shared rules helper: **validate/apply move** (minimale RegelprÃ¼fung fÃ¼r toFound/toPile/flip)  
2) `server.js`: Bot-Moves vor Broadcast durch validate/apply schicken  
3) Danach: Bot-State Mapping Debug (serverbot.js)

---

