# Handover – 2026-01-17 – Solitaire HighNoon

## Ziel
Vorbereitung des Wechsels zu **server‑authoritativer Game‑Logik**, da trotz umfangreicher Client‑Fixes weiterhin inkonsistente Karten‑ und Deckzustände auftreten (z. B. doppelte Karten, unvollständige Decks, Bot‑Anomalien).

---

## 1. Beobachtete Symptome

- **Doppelte Karten** nach Pile‑to‑Pile‑Moves (v. a. unter Stress / schnellem Spielen)
- **Soft‑Lock**: Nach intensivem Pile‑to‑Pile‑Spielen keine weiteren Züge möglich
- **Drift** zwischen Clients (iOS ↔ iOS) und zwischen Client ↔ Bot
- Im Bot‑Spiel:
  - **3× dieselbe Karte**
  - **unvollständige Kartensets**
- Symptome treten **nicht deterministisch**, sondern nach längerer Session auf

➡️ Diese Effekte deuten stark auf **State‑Ownership‑Probleme** hin, nicht nur auf UI‑ oder Optimistic‑Issues.

---

## 2. Relevante Log‑Hinweise

- Häufige Muster:
  - `M7 RX skip: duplicate moveId=...`
  - `OPTIMISTIC skip: duplicateSig=...`

- Kritische Erkenntnis:
  - Wenn **Optimistic Apply** durch Signature‑De‑Dup blockiert wird **und**
  - das Server‑Echo später ebenfalls per `moveId` deduped wird,
  - dann wird ein gültiger Zug **lokal nie angewendet** → Drift / Soft‑Lock.

---

## 3. Heute umgesetzte Client‑Fixes (iOS)

### M6 – Flip / Recycle stabilisieren
- Flip / Recycle werden **lokal sofort angewendet**
- Verwendung von `cardId`, `stockCount`, `wasteCount`
- Ziel: Snapshot‑Spam bei schnellem Tippen vermeiden

### M7 – Optimistic / De‑Dup Hardening

- **Primärer Guard:** `moveId` / `seq`
- **Problem:** Signature‑De‑Dup (`duplicateSig`) war zu grob

#### M7.4 (entscheidend)
- Signature‑De‑Dup darf **niemals** Optimistic Apply blockieren
- Neue Regel:
  - Signature‑Duplikate → **nur Log/Warn**
  - **kein Skip / kein Return**
- Begründung:
  - Verhindert Drift, wenn Server‑Echo ebenfalls deduped wird

**Status:**
- Nach Stress‑Tests kein reproduzierbarer Soft‑Lock mehr
- Kein `OPTIMISTIC warn` im Log ist **erwartet**, da iOS‑Moves fast immer `moveId + seq` tragen

---

## 4. Aktueller Stand (Ende Tag)

✅ Doppelte Karten durch Optimistic‑Bug scheinbar behoben

⚠️ Weiterhin:
- Unvollständige Decks
- Mehrfach vorkommende Karten (v. a. Bot‑Spiel)

➡️ Diese Probleme sind **nicht plausibel allein clientseitig erklärbar**

---

## 5. Architektonische Schlussfolgerung

### Entscheidung: **Server‑authoritative Game State**

Weiteres Debugging auf Client‑Ebene ist ineffizient. Die verbleibenden Fehler sprechen für:

- Mehrere gleichzeitige **Deck‑Quellen** (iOS, PWA, Serverbot)
- Unscharfe Ownership von:
  - Deck‑Erzeugung
  - Deal / Reset
  - Move‑Apply
- Race‑Conditions zwischen Bot, Client‑Optimistic und Snapshots

---

## 6. Zielbild (High Level)

### Server
- **Single Source of Truth** pro Match
- Verantwortlich für:
  - Deck‑Erzeugung & Shuffle
  - Deal / Reset
  - Move‑Validation (Regeln)
  - Move‑Apply (State Transition)
  - `matchRev` (monoton)
  - Snapshot / Delta Broadcast

### Client (iOS / Web)
- Sendet nur **Move‑Intents**:
  - `moveId`, `seq`, `baseRev`, `intent`
- Optional kosmetisches Optimistic UI
- Server‑State überschreibt immer

### Bot
- Kein eigener Game‑State mehr
- Arbeitet **ausschliesslich** auf Server‑State
- Bot‑Moves = normale Server‑Moves

---

## 7. Pragmatische Migration (empfohlen)

### Phase 1 – Minimal server‑authoritative
- Server kontrolliert:
  - Deck
  - Deal / Reset
  - Move‑Apply
- Clients empfangen vollständige Snapshots

### Phase 2 – Deltas / Revisions
- Einführung:
  - `baseRev`
  - `move_ack` / `move_reject`
  - `state_patch`

### Phase 3 – Optional
- Reduzierte Snapshots
- Bessere Anti‑Cheat‑Basis

---

## 8. Offene Punkte für nächsten Orchestrator‑Agent

- Wo werden aktuell Decks erzeugt?
  - iOS (`applyDeterministicDeal`)
  - PWA (`game.js`)
  - Serverbot (`serverbot.js`)
  - Server (`server.js / matches.js`)

- Bedeutung der **`S‑UNK‑*` CardIds** im Bot‑Log
  - Hinweis auf instabile / temporäre Karten‑IDs

- Wo kann double‑apply passieren?
  - Optimistic + Echo + Snapshot

---

## Kurzfazit

Die heutigen Fixes haben **Client‑seitige Drift‑Ursachen** entschärft.

Die verbleibenden Fehler sind **architektonisch**.

➡️ Der nächste sinnvolle Schritt ist ein **klar server‑authoritativer Game‑State**.

