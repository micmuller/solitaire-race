# ADR-0001: Einführung eines server-authoritativen Game States

## Status
- **Status:** Accepted (Phase P1 abgeschlossen)
- **Datum:** 2026-01-18
- **Projekt:** Solitaire HighNoon
- **Entscheider:** Michael Müller
- **Beteiligte Komponenten:** iOS Client, Web/PWA Client, Server, ServerBot, Protocol

---

## Kontext / Problemstellung

Solitaire HighNoon ist ein deterministisches Multiplayer-Spiel mit:
- iOS Native Client
- Web/PWA Client
- ServerBot
- Node.js WebSocket Server

Ursprünglich lag ein signifenter Teil der Spiellogik auf den Clients
(Optimistic Apply, lokale Deck- und Move-Logik).

### Beobachtete Probleme
- Nicht-deterministische Fehler nach längerer Spielzeit:
  - doppelte Karten
  - unvollständige Decks
  - Placeholder-Karten (`0UNK`, `W-FLIP-UNK-*`)
- Drift zwischen Clients (iOS ↔ iOS, iOS ↔ Bot)
- Race Conditions zwischen:
  - Optimistic Client Moves
  - Server Echo
  - Snapshots
- Hoher Debug-Aufwand mit schlechter Reproduzierbarkeit

Diese Probleme konnten **nicht nachhaltig clientseitig gelöst** werden,
ohne die Komplexität weiter zu erhöhen.

---

## Entscheidung

Wir führen schrittweise einen **server-authoritativen Game State** ein.

### Kernaussage
> **Der Server ist die einzige Quelle der Wahrheit für den Spielzustand.**

Clients:
- senden nur **Move-Intents**
- halten **keinen autoritativen State**
- akzeptieren Server-States immer als final

---

## Entscheidungsziele

1) **Determinismus**
   - Gleiche Inputs → gleicher State
2) **Drift-Vermeidung**
   - Kein divergierender Client-State
3) **Vereinfachtes Debugging**
   - Eine Wahrheit statt N Varianten
4) **Stabile Bot-Integration**
   - Bot nutzt exakt dieselbe Logik wie Humans
5) **Zukunftsfähigkeit**
   - Grundlage für Replays, Anti-Cheat, Spectator Mode

---

## Lösungsansatz (Phasenmodell)

### Phase P1 – Stabilisierung (laufend / abgeschlossen)
- Client Hardening:
  - Keine Moves ohne `cardId`
  - Keine Materialisierung unbekannter Karten
- Server Safety Nets:
  - Drop invalid moves
  - Snapshot-Resync
- Ziel:
  - Symptome eliminieren
  - System stabilisieren

---

### Phase P2 – Übergang zu Server-Authoritative

**State Ownership**
- Server:
  - validiert Moves
  - applied Moves
  - erhöht `matchRev`
- Client:
  - sendet `{ intent, moveId, seq, baseRev }`
  - rendert Server-State

**Mechaniken**
- `matchRev` als monotone Ordnungsgröße
- `MOVE_ACK` / `MOVE_REJECT`
- Snapshots als Fallback

---

### Phase P3 – Vollständig Server-Authoritative

- Deck-Erzeugung nur auf Server
- Shuffle / Deal / Recycle serverseitig
- Bot = Server-internaler Player
- Clients:
  - rein deklarativ
  - optional kosmetisches Optimistic UI

---

## Konsequenzen

### Positive Konsequenzen
- Kein Client-Drift mehr
- Klarer Debug-Pfad
- Vereinfachte Bot-Logik
- Höhere Protokoll-Stabilität

### Negative / Trade-offs
- Mehr Server-Verantwortung
- Höhere Latenz-Sensitivität
- Snapshots anfangs größer (Performance)

Diese Trade-offs werden bewusst akzeptiert.

---

## Alternativen (bewusst verworfen)

### 1) Vollständig Client-Authoritativ
❌ Verworfen:
- nicht skalierbar
- driftanfällig
- Bot schwer integrierbar

### 2) Hybrid ohne klare Ownership
❌ Verworfen:
- genau die aktuelle Problemklasse
- schwer debugbar
- inkonsistente Zustände

---

## Auswirkungen auf bestehende Komponenten

### Protocol
- Additiv erweitert
- Keine Breaking Changes in P2
- Versionierung (`protocolVersion`) bleibt Pflicht

### Server
- Wird State-Owner
- Erhöhte Logging-Anforderungen

### Clients (iOS / Web)
- Weniger Logik
- Mehr Rendering
- Klare Apply-Regeln

---

## Offene Punkte

- Exakte Snapshot-Frequenz in P2
- Delta-Format (`STATE_PATCH`)
- Replay- / Spectator-Use-Cases

---

## Leitprinzip (dauerhaft)

> **Determinism > UI Convenience**  
> **Server Authority > Client Optimism**  
> **Protocol Stability > schnelle Fixes**

---

## Referenzen
- Handoff 2026-01-17 / 2026-01-18
- PROTOCOL_NOTES.md
- PROJECT_OVERVIEW.md