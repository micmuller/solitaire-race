# ðŸ§  Handoff â€“ Solitaire HighNoon

**Datum:** 2026-01-25  
**Session-Fokus:** P1 Server-Authoritative Move-Gate + Bot-Stabilisierung (Schema v1) + Reject-Loop-Fixes  
**Status:** Bot spielt wieder mehrere ZÃ¼ge; Server-Gate stabil; Bot-Strategie fachlich fehlerhaft â†’ Neuentwurf nÃ¶tig

---

## âœ… Was heute erreicht wurde

### 1) Server-authoritative Gate fÃ¼r Bot-Moves
- `server.js`: Bot-Moves laufen strikt Ã¼ber `matches.validateAndApplyMove()`.
- Fallback entfernt â†’ **keine Broadcasts bei invalid Moves**.
- Bei Reject: Snapshot-Convergence via `requestSnapshotFromRoom(... move_reject:reason)`.

### 2) Schema-KompatibilitÃ¤t in `matches.js` (P1.3 / v1)
- UnterstÃ¼tzt **v1 sided Schema**:
  - `state.you|opp.stock / waste / tableau`
  - `foundations` als Array (8 Slots)
- ZusÃ¤tzlich weiterhin Legacy-Schema.
- Wichtige Fixes:
  - Normalisierung von Bot-Moves mit numerischem `from/to`.
  - `cardId` muss **Top-Card** des Source-Piles sein  
    â†’ neuer Reject `card_not_on_top` statt irrefÃ¼hrendem `card_face_down`.
  - Verhindert illegale Bot-Moves aus der Mitte eines Stapels.

### 3) Bot bleibt nach erstem legalen Move nicht mehr stehen
- `serverbot.js`: Bot bevorzugt **server-authoritativen Snapshot** (`getSnapshot()`), nicht nur Client-`bot_state`.
- Bei `matchRev`-Change wird `recentMoveSigs` geleert â†’ De-Dup blockt keine legitimen Folgemoves mehr.

### 4) Flip / Draw Protokoll-Mismatch behoben
- Bot sendet fÃ¼r Stockâ†’Waste jetzt `kind=draw` statt `flip`.
- `flip` bleibt ausschlieÃŸlich fÃ¼r Tableau-Top-Karte aufdecken.
- Entfernt `flip_not_needed` Reject-Spam.

---

## âš ï¸ Offene / erkannte Probleme

### A) Bot-Strategie fachlich fehlerhaft
Beobachtungen:
- Eine **2 wurde direkt auf Foundation gelegt**, aber **nicht auf das zugehÃ¶rige Ass**, obwohl dieses bereits lag.
- Es kommen weiterhin Rejects herein (nicht mehr wegen Schema, sondern wegen falscher Bot-Entscheidungen).

**Fazit:**  
Gate + Apply sind korrekt und stabil.  
Die **Bot-Logik selbst ist inhaltlich nicht korrekt** und muss **von Grund auf neu entworfen** werden (server-authoritative, regelkonform, deterministisch).

### B) UnabhÃ¤ngiges Problem: iOS â†” iOS (Shared + Split)
- Am Spielende fehlen Karten â†’ Spiel kann nicht beendet werden.
- Betrifft **Shared** und **Split**.
- Verdacht: Drift / Card-Loss durch Apply-Fehler, Snapshot-Fehler oder fehlende Safety-Checks.

---

## ðŸ§¾ Entscheidungen (inkl. Compatibility)

1) **Kein Protokoll-Bruch**  
   Gate/Rejects bleiben server-intern, keine neuen Pflichtfelder im Protokoll.

2) **Server bleibt Source of Truth**  
   Apply + Validation ausschlieÃŸlich serverseitig.

3) **Bot kÃ¼nftig rein server-state-driven**  
   Client-`bot_state` nur noch als Telemetrie / Hint, nicht als Entscheidungsgrundlage.

4) **Bot-Moves kÃ¼nftig mit Preflight**  
   Vor dem Senden: serverseitige `validateMove()`-PrÃ¼fung, um Reject-Loops zu verhindern.

---

## ðŸ—ºï¸ Ziele & Plan â€“ nÃ¤chster Durchgang

### Track 1: Bot v2 â€“ von Grund auf korrekt (Server-Authoritative)

**Ziel:** Regelkonformer, deterministischer Bot ohne Reject-Loops.

1) **Bot-State Contract definieren**
   - Bot liest ausschlieÃŸlich `getSnapshot(matchId).state`.
   - Normalisierung in **eine klare Bot-View**:
     - `tableau[7]`, `waste`, `stock`, `foundations[4]` fÃ¼r Bot-Seite.
   - Klare Definition:
     - Welche 4 der 8 Foundation-Slots gehÃ¶ren zur Bot-Seite?
     - Shared vs. Split eindeutig abbilden.

2) **Foundations korrekt mappen**
   - Zielwahl nur:
     - passender Suit
     - `topRank + 1`
   - Explizite Tests:
     - Ace â†’ leere Foundation
     - 2 â†’ passendes Ass
     - keine Cross-Suit / falsche Slots

3) **Move-Generator strikt**
   - Nur **Top-Cards** aus Tableau/Waste.
   - Kein Zugriff auf Karten in der Mitte.
   - Flip nur bei `top.up === false`.
   - Draw nur wenn keine anderen legalen Moves.
   - Recycle nur wenn `stock == 0 && waste > 0`.

4) **Preflight vor Send**
   - Bot prÃ¼ft jeden Move mit `matches.validateMove()` (Dry-Run).
   - Nur gÃ¼ltige Moves werden gesendet.

5) **Determinism & Debug**
   - Bot-Decision-Log mit:
     - matchRev
     - Anzahl legaler Moves
     - Entscheidungsgrund (Reason-Code)

---

### Track 2: iOS â†” iOS Bugfix â€“ fehlende Karten (Shared + Split)

**Ziel:** Keine Card-Loss-Bugs mehr, klar diagnostizierbar, sichtbare Counts.

1) **Safety-Invariants im Server**
   - Nach jedem Apply:
     - Card-Conservation-Check
     - erwartete Gesamtzahl (je nach Mode)
     - keine Duplicate-IDs
     - keine verlorenen Karten
   - Bei Verletzung:
     - `[AIRBAG] card_conservation_failed`
     - sofortiger Snapshot-Broadcast.

2) **Counts sichtbar machen**
   - iOS UI:
     - Anzeige verbleibender Karten im Stock
     - fÃ¼r *you* und *opp* (Split)
   - Server garantiert:
     - `stock.length` oder `stockCount` pro Seite im Snapshot.

3) **Instrumentation & Repro**
   - Logging:
     - `matchRev`, `moveId`, `sig`, `snapshotHash`
     - Counts: stock/waste/tableau/foundations pro Seite
   - Am Spielende: Dump aller Counts.

4) **QA / Test-Matrix**
   - iOS host â†” iOS guest
   - Shared + Split
   - 50+ Moves + Endgame
   - Reconnect / state_request
   - Erwartung:
     - Karteninvariant hÃ¤lt
     - kein unfinishable Game.

---

## ðŸ§© Heute betroffene Files

- `server.js`
  - Gate/Reject strikt, kein Fallback
  - erweitertes Reject-Debug

- `matches.js`
  - v1 sided Schema Support
  - Index-Normalisierung
  - `card_not_on_top` Validierung

- `serverbot.js`
  - v1.10: server-authoritative Snapshot bevorzugt
  - v1.11: `draw` statt `flip` fÃ¼r Stockâ†’Waste

---

## ðŸ“Œ Empfehlung fÃ¼r den nÃ¤chsten Einstieg
1) **Bot v2 Design & Implementierung** (Foundations-Mapping + Legal-Move-Enumeration).
2) Danach **iOSâ†”iOS Card-Conservation Airbag + Stock-Count UI**.

ðŸ‘‰ Einstieg nÃ¤chstes Mal z.B. mit:
- â€žBot v2 anfangenâ€œ
- oder â€žiOSâ€“iOS missing cards zuerstâ€œ

---